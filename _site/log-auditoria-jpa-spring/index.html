<!DOCTYPE html>
<html>
  <head>
    <title>Log de Auditoria - JPA + Spring – Maciel Bombonato – Desenvolvedor de software</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Mais um dos antigos migrados para cá.

" />
    <meta property="og:description" content="Mais um dos antigos migrados para cá.

" />
    
    <meta name="author" content="Maciel Bombonato" />

    
    <meta property="og:title" content="Log de Auditoria - JPA + Spring" />
    <meta property="twitter:title" content="Log de Auditoria - JPA + Spring" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="Maciel Bombonato - Desenvolvedor de software" href="/feed.xml" />
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

  </head>

  <body>

    <div class="page-header">
        <div class="wrapper-masthead">
         <div class="container">
           <header class="clearfix">
             <div class="site-info">
               <h1 class="site-name"><a href="/">Maciel Bombonato</a></h1>
             </div>
             <nav>
               <a href="/">Blog</a>
               <a href="/about">About</a>
               <a href="/projects">Projects</a>
             </nav>
           </header>
         </div>
         <div class="container">
           <div class="post-heading">
               <h1>Log de Auditoria - JPA + Spring</h1>
               <span class="meta">
                  Criado em: 19/11/2012
               </span>
           </div>
         </div>
       </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
 <div class="space-extra-small">
 </div>

  <div class="entry">
    <p>Mais um dos antigos migrados para cá.</p>

<h1 id="log-de-auditoria---jpa--spring">Log de Auditoria - JPA + Spring</h1>

<hr />

<p>Vira e volta, aparecem sistemas onde é necessário fazer um esquema de log de auditoria para uma tabela ou várias.</p>

<p>Montei um esquema que pode ser facilmente extendido para outras tabelas do sistema, para fazê-lo, basta seguir os passos abaixo:</p>

<h3 id="1-criar-um-enum-para-representar-as-ações-de-banco">1. Criar um enum para representar as ações de banco:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>public enum TransactionType {
    CREATE, UPDATE, DELETE;
}
</code></pre>
</div>

<h3 id="2-criar-a-entidade-de-log-de-auditoria">2. Criar a entidade de log de auditoria:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>@Entity
@Table(name = "log_trace")
@AttributeOverride(name = "id", column = @Column(name = "log_trace_id"))
public class LogTrace extends BaseEntity {

    @Column(name = "transaction_type", nullable = false)
    @Enumerated(EnumType.STRING)
    private TransactionType transactionType;

    @Column(name = "entity_name", nullable = false)
    private String entityName;

    @Column(name = "registry_id", nullable = false)
    private Long registryId;

    @Column(name = "operation_date", nullable = false)
    @Temporal(TemporalType.TIMESTAMP)
    private Date operationDate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "executed_by", nullable = false)
    private User executedBy;

...getters e setters...
}
</code></pre>
</div>

<h3 id="3-criar-o-repositório-dao-e-o-serviço-como-está-sendo-feito-no-restante-do-sistema">3. Criar o repositório (DAO) e o serviço como está sendo feito no restante do sistema;</h3>

<h3 id="4-criar-o-listener-que-será-disparado-pelo-hibernate">4. Criar o listener que será disparado pelo hibernate:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>public class LogTraceListener {

    @Autowired
    LogTraceService logTraceService;

    @Autowired
    UserService userService;

    @PostRemove
    void postDelete(BaseEntity e) {
        createLog(TransactionType.DELETE, e);
    }

    @PostPersist
    void postPersist(BaseEntity e) {
        createLog(TransactionType.CREATE, e);
    }

    @PostUpdate
    void postUpdate(BaseEntity e) {
        createLog(TransactionType.UPDATE, e);
    }

    private void createLog(TransactionType transactionType, BaseEntity e) {
        /*
         * OBSERVAÇÃO 1.
         */
        if (logTraceService == null) {
            ApplicationContext ctx = ContextLoader.getCurrentWebApplicationContext();

            logTraceService = (LogTraceService) ctx.getBean("logTraceService");
        }

        /*
         * OBSERVAÇÃO 2.
         */
        User user = userService.getAuthenticatedUser();

        LogTrace logTrace = new LogTrace();
        /*
         * OBSERVAÇÃO 3.
         */
        String entityName = e.getClass().getAnnotation(Table.class).name();
        if (entityName == null || entityName.isEmpty()) {
            entityName = e.getClass().getSimpleName();
        }

        logTrace.setTransactionType(transactionType);
        logTrace.setEntityName(entityName);
        logTrace.setRegistryId(e.getId());
        logTrace.setExecutedBy(user);
        logTrace.setOperationDate(new Date());

        logTraceService.save(logTrace);
    }
}
</code></pre>
</div>

<h2 id="observações">Observações:</h2>

<ol>
  <li>O listener é disparado pelo mecanismo JPA. Uma vez que a classe não foi instanciada pelo Spring, as dependências não são injetadas e para resolver isso, podemos usar aspéctos (AOP) ou uma abordagem mais simples como a feita acima;</li>
  <li>A lógica de recuperação do usuário logado (via consulta ou busca na sessão) está no serviço neste caso;</li>
  <li>Alguns projetos adotam o uso da anotação <strong>@Table</strong>, neste listener, coloquei uma lógica que abrange esta abordagem (como principal) e se não for o caso, o campo receberá o nome da entidade, por exemplo, “PedidoInterno”, ao invés de “pedido_interno” (que é a forma como os bancos normalmente são modelados. Veja que nossa “LogTrace” teria o campo salvo como “log_trace”;</li>
  <li>Anotar entidades que devem ser auditadas:
As entidades que devem ser auditadas recebem a anotação <strong>@EntityListeners(value = LogTraceListener.class)</strong>. Para melhorar a leitura da classe, indico colocar esta anotação logo após a anotação <strong>@Entity</strong> ou <strong>@Table(name = “minha_entidade”)</strong>.</li>
</ol>

<p>Com isso, sempre que uma das operações monitoradas pelo listener acontecer, são as anotações que estão sobre os métodos: <strong>@PostPersist</strong>, <strong>@PostUpdate</strong> e <strong>@PostRemove</strong>, um registro será gerado na tabela de log de auditoria.</p>

<p>Para que outra tabela/entidade seja autitada, basta repetir o passo 5 (incluir a anotação na entidade).</p>

<blockquote>
  <p>NOTA: Normalmente as entidades de um sistema extendem uma entidade base ou implementam uma interface para que um padrão “mínimo” seja seguido. Este exemplo foi construído considerando este caso, ou seja, as entidades extendem BaseEntity.</p>
</blockquote>

  </div>

  <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://bombonato-net.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
            <div class="svg-icon">
          
<a href="mailto:maciel@bombonato.net"><i class="icon-envelope icon-2x"></i></a>


<a href="https://github.com/macielbombonato"><i class="icon-github icon-2x"></i></a>

<a href="https://www.linkedin.com/in/macielbombonato"><i class="icon-linkedin-sign icon-2x"></i></a>


<a href="https://www.twitter.com/macielbombonato"><i class="icon-twitter icon-2x"></i></a>




            </div>
        </footer>
      </div>
    </div>


    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-60177831-5', 'auto');
		ga('send', 'pageview', {
		  'page': '/log-auditoria-jpa-spring/',
		  'title': 'Log de Auditoria - JPA + Spring'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
